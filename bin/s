#!/bin/ksh -e

curlit() {
	curl -s --data-urlencode "q=$q" -d "pageno=$p" \
		-d "format=rss" "https://search.datensturm.net"
}

sedit() {
	sed 's/[ \t]*<[^>]*>//;s/<.*//'
}

if [[ "$1" == "-l" ]]; then
	shift
	lucky=true
else
	lucky=false
fi

ask_query() {
	printf "q: " >&2
	read q
}

[[ -z "$@" ]] && ask_query || q="$@"
p=1

if $lucky; then
	$BROWSE `curlit | grep -e "<link" | tail +2 | head -1 | sedit`
else
	tmp=`mktemp /tmp/searxXXXXXXXX`
	trap "rm $tmp" INT

	omenu() {
		# echo "<ol>"
		curl -s --data-urlencode "q=$q" -d "pageno=$p"\
			-d "format=rss" "https://search.datensturm.net" | \
			grep -e "<title" -e "<link" -e "<desc" | tail +4 | \
			sed 's/[ \t]*<[^>]*>//;s/<.*//' | while read title
		do
			read link ; read desc
			echo $link >>$tmp
			echo $title
			echo $desc
		done | menu

		read c

		case $c in
			n*)
				p=$((p + 1))
				omenu
				;;
			p*)
				p=$((p - 1))
				omenu
				;;
			q*)
				rm $tmp
				exit 1
				;;
			s*)
				ask_query
				p=1
				omenu
				;;
			*)
				$BROWSER `sed "${c}p;d" $tmp`
				rm $tmp
				exit 0
		esac
	}

	omenu
fi
