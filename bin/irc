#!/bin/ksh -e
server=irc.freenode.net

waitfor() {
	echo -n WAIT FOR $1...
	while [ ! ${2:--f} $1 ]; do
		sleep 1
	done
	echo OK
}

IRCDIR="/tmp/irc$(openssl rand -hex 8)"
ii -e ssl -s $server -i $IRCDIR &

[ -d $IRCDIR ] || mkdir -p $IRCDIR
waitfor $IRCDIR/$server -d
cd $IRCDIR/$server

waitfor out
tail -f out &

echo /nickserv identify $(whoami) $(pass irc) > in
waitfor nickserv/out
tail -f nickserv/out &

doloop=true
chpid=
channel=.

end() {
	kill 0
	rm -rf $IRCDIR
	cd -
}

trap end INT

cat | while read -r first rest
do
	case $first in
		/j*)
			channel=$rest
			echo /j $channel > in
			if [[ $channel == \#* ]]; then
				waitfor "$channel/out"
				[ -z $chpid ] || kill $chpid
				tail -f "$channel/out" &
				chpid=$!
			fi
			;;
		*) echo "$first $rest" > $channel/in;;
	esac
done

end
wait
