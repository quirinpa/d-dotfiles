#!/bin/ksh -e
trap 'bspc config top_padding 0; kill -TERM -- -$$' EXIT

height=19
bspc config top_padding $height

c_bg=`xget background`

in_dir=/tmp/barin
[ -d $in_dir ] || mkdir $in_dir
inotifywait -r $in_dir -m -e MODIFY,DELETE,CREATE | \
	while read -r ufile ; do
		str=$(cat $in_dir/* | tr "\n" " ")
		# echo $ufile >&2
		echo "${str%?}"
	done | lemonbar -a 32 -g x$height \
		-F "`xget foreground`" -B "$c_bg" &
		# -f "`xget font || echo`" \

c_empty=`xget color5`
c_busy=`xget color13`
c_urgent=`xget color9`
c_unknown=`xget color8`

color_check() {
	[[ "$1" == "$color" ]] || {
		color=$1
		printf "%%{F$1}"
	};
}

bspc subscribe report | \
	while read -r line; do
		{
			IFS=":"
			for item in $line; do
				name=${item#?}
				case $item in
					[fFoOuU]*)
						case $item in
							[fF]*) c=$c_empty; icon=\  ;;
							[oO]*) c=$c_busy; icon=\.;;
							[uU]*) c=$c_urgent; icon=\!;;
						esac
						if [[ $item == [FOU]* ]]; then
							printf "%%{B$c}%%{F$c_bg}$icon%%{B-}"
							color="$c_bg"
						else
							color_check $c
							printf "$icon"
						fi;;
					[LTG]*) 
						color_check $c_unknown
						printf "$name"
				esac
			done
		} | xargs -0 notify-send -t 0 -f 000
	done &

xtitle -s -f '%s\n' -t 20 | \
	while read -r title; do
		notify-send -f 001 -t 0 "%{c}%{F-}$title"
	done &

notify-send -f 002 -t 0 "%{r}"

c_good=`xget color10`
c_normal=`xget color12`
c_bad=`xget color1`

BAT0="sysctl -n hw.sensors.acpibat0"
if [[ ! -z "`$BAT0`" ]]; then
	full=`$BAT0.amphour0 | sed 's/.A.*//'`
	showbat() {
		case "`$BAT0.raw0`" in
			*discharging*) c=$c_bad;;
			*) c=$c_good;;
		esac
		now=`$BAT0.amphour3 | sed 's/.A.*//'`
		printf "%%{F$c}B%%{F-} %d%%" \
			`echo "100 * $now / $full" | bc`
	}
	SHOWBAT=showbat
fi

icond() { echo "%{F$c_normal}$1%{F-}"; }
while true; do
	{
		icond D; date +"%d/%m %H:%M"
		# icond V; amixer sget Master | grep -Po "\d+%"
		$SHOWBAT
	} | xargs notify-send -f zzz -t 0
	sleep 60
done &

notify-send init
wait
