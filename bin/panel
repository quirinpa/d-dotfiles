#!/bin/ksh -e

# TODO FIX PPIDS OR WRITE THIS IN C
finish() {
	bspc config top_padding 0
	pkill lemonbar
	pkill -P -$$
}

trap 'finish' EXIT INT

height=15
bspc config top_padding $height

c_bg=`xg background`

in_dir=/tmp/barin
[ -d $in_dir ] || mkdir $in_dir
inotifywait -r $in_dir -m -e MODIFY,DELETE,CREATE | \
	while read -r ufile ; do
		str=$(cat $in_dir/* | tr "\n" " ")
		echo "${str%?}"
	done | lemonbar -a 32 -g x$height \
		-F "`xg color8`" -B "$c_bg" &

c_empty=`xg color5`
c_busy=`xg color13`
c_urgent=`xg color9`

color_check() {
	[[ "$1" == "$color" ]] || {
		color=$1
		printf "%%{F$1}"
	};
}

bspc subscribe report | \
	while read -r line; do
		{
			IFS=":"
			for item in $line; do
				name=${item#?}
				case $item in
					[fFoOuU]*)
						case $item in
							[fF]*) c=$c_empty; icon=\  ;;
							[oO]*) c=$c_busy; icon=\.;;
							[uU]*) c=$c_urgent; icon=\!;;
						esac
						if [[ $item == [FOU]* ]]; then
							printf "%%{B$c}%%{F$c_bg}$icon%%{B-}"
							color="$c_bg"
						else
							color_check $c
							printf "$icon"
						fi;;
					[LTG]*) 
						color_check -
						printf "$name"
				esac
			done
		} | xargs -0 notify-send -t 0 -f 000
	done &

xtitle -s -f '%s\n' -t 60 | \
	while read -r title; do
		notify-send -f 001 -t 0 "%{c}%{F$c_busy}$title%{F-}"
	done &

notify-send -f 002 -t 0 "%{r}"

c_good=`xg color10`
c_bad=`xg color1`

BAT0="sysctl -n hw.sensors.acpibat0"
if [[ ! -z "`$BAT0`" ]]; then
	full=`$BAT0.amphour0 | sed 's/.A.*//'`
	showbat() {
		case "`$BAT0.raw0`" in
			*discharging*) c=$c_bad;;
			*) c=$c_good;;
		esac
		now=`$BAT0.amphour3 | sed 's/.A.*//'`
		printf "%%{F$c}B%%{F-} %d%%" \
			`echo "100 * $now / $full" | bc`
	}
	SHOWBAT=showbat
fi

while true; do
	{
		$SHOWBAT
		date +"%%{F$c_busy} D%%{F-} %d/%m %H:%M"
	} | xargs notify-send -f zzz -t 0
	sleep 60
done &

notify-send -i wm Initialized
mailcheck
wait
finish
